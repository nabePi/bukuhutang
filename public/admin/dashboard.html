<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BukuHutang Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        header h1 { font-size: 2em; margin-bottom: 5px; }
        header p { opacity: 0.9; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stat-card .icon { font-size: 2em; margin-bottom: 10px; }
        .stat-card h3 { 
            color: #94a3b8; 
            font-size: 0.85em; 
            text-transform: uppercase; 
            margin-bottom: 8px;
            line-height: 1.2;
        }
        .stat-card .value { 
            font-size: 1.8em; 
            font-weight: bold; 
            color: #f8fafc;
            word-break: break-word;
        }
        
        .section {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        .section h2 {
            color: #f8fafc;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 10px;
            transition: all 0.3s;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: #0f172a;
            border-radius: 8px;
            overflow: hidden;
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
            white-space: normal;
            word-break: break-word;
        }
        th { 
            background: #334155; 
            font-weight: 600; 
            font-size: 0.85em;
            white-space: nowrap;
        }
        tr:hover { background: #1e293b; }
        
        .status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }
        .status.active { background: #065f46; color: #6ee7b7; }
        .status.pending { background: #92400e; color: #fcd34d; }
        .status.overdue { background: #7f1d1d; color: #fca5a5; }
        .status.paid { background: #1e3a5f; color: #93c5fd; }
        
        @media (max-width: 768px) {
            .status {
                font-size: 0.7em;
                padding: 3px 8px;
            }
        }
        
        #qrCodeContainer {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 15px;
        }
        #qrCodeImage { width: 200px; height: 200px; }
        
        .loading { color: #94a3b8; font-style: italic; }
        .empty { color: #64748b; text-align: center; padding: 30px; }
        
        /* Policy table responsive */
        #policyContent table {
            width: 100%;
            font-size: 0.9em;
        }
        #policyContent td, #policyContent th {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #policyContent td:first-child {
            font-weight: 500;
            color: #94a3b8;
            max-width: 60%;
        }
        #policyContent td:last-child {
            text-align: right;
            font-weight: 600;
            color: #60a5fa;
        }
        
        @media (max-width: 768px) {
            #policyContent table {
                font-size: 0.8em;
            }
            #policyContent th, #policyContent td {
                padding: 8px 10px;
            }
            #policyContent td:first-child {
                max-width: 55%;
            }
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 20px;
            background: #334155;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab.active { background: #3b82f6; }
        .tab:hover { background: #475569; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            header { padding: 15px; }
            header h1 { font-size: 1.3em; }
            header p { font-size: 0.85em; }
            
            .stats-grid { 
                grid-template-columns: 1fr; 
                gap: 10px;
            }
            .stat-card { 
                padding: 15px; 
                min-height: auto;
            }
            .stat-card .icon { font-size: 1.5em; }
            .stat-card h3 { font-size: 0.75em; }
            .stat-card .value { font-size: 1.4em; }
            
            .section { padding: 15px; }
            .section h2 { font-size: 1.1em; }
            
            .tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            .tab {
                padding: 8px 12px;
                font-size: 0.85em;
                flex: 1;
                min-width: 100px;
                text-align: center;
            }
            
            table { 
                font-size: 0.8em; 
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            th, td { 
                padding: 8px 6px; 
                white-space: nowrap;
            }
            th:first-child, td:first-child {
                position: sticky;
                left: 0;
                background: #0f172a;
                z-index: 1;
            }
            th:first-child {
                background: #334155;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 0.8em;
            }
        }
        
        @media (max-width: 480px) {
            .stat-card .value { font-size: 1.2em; }
            .tabs { flex-direction: column; }
            .tab { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä BukuHutang Dashboard</h1>
            <p>Panel Admin - Single Admin Mode</p>
        </header>
        
        <!-- WhatsApp Connection -->
        <div class="section" style="border: 2px solid #3b82f6;">
            <h2>üì± WhatsApp Connection</h2>
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1;">
                    <p><strong>Status:</strong> <span id="waStatusText" class="loading">Loading...</span></p>
                    <p id="waPhoneDisplay" style="display: none;"><strong>Nomor:</strong> <span id="waPhoneNumber">-</span></p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="refreshWA()">üîÑ Cek Status</button>
                        <button class="btn btn-success" id="btnGenerateQR" style="display: none;" onclick="generateQRCode()">üì± Generate QR Code</button>
                        <button class="btn btn-danger" id="btnLogout" style="display: none;" onclick="logoutWA()">üî¥ Logout</button>
                    </div>
                </div>
                <div>
                    <div id="qrLoading" style="padding: 30px; display: none;">‚è≥ Memuat QR Code...</div>
                    <div id="qrCodeContainer" style="display: none;">
                        <img id="qrCodeImage" src="" alt="QR Code">
                        <p style="color: #0f172a; text-align: center; margin-top: 10px; font-size: 0.9em;">Scan dengan WhatsApp</p>
                        <p id="qrTimeout" style="color: #ef4444; text-align: center; font-size: 0.85em; margin-top: 5px;">‚è±Ô∏è QR berlaku 2 menit</p>
                    </div>
                    <div id="waConnected" style="display: none; text-align: center; padding: 30px;">
                        <div style="font-size: 4em;">‚úÖ</div>
                        <p style="color: #10b981; font-weight: bold;">Connected</p>
                    </div>
                    <div id="waDisconnected" style="text-align: center; padding: 30px;">
                        <div style="font-size: 3em;">üìµ</div>
                        <p style="color: #94a3b8; margin-top: 10px;">WhatsApp belum terhubung</p>
                        <p style="color: #64748b; font-size: 0.85em;">Klik "Generate QR Code" untuk connect</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">üí∞</div>
                <h3>Total Piutang Aktif</h3>
                <div class="value" id="totalPiutang">Rp 0</div>
            </div>
            <div class="stat-card">
                <div class="icon">üë•</div>
                <h3>Total Borrower</h3>
                <div class="value" id="totalBorrowers">0</div>
            </div>
            <div class="stat-card">
                <div class="icon">üìã</div>
                <h3>Perjanjian Aktif</h3>
                <div class="value" id="totalAgreements">0</div>
            </div>
            <div class="stat-card">
                <div class="icon">üìÖ</div>
                <h3>Cicilan Pending</h3>
                <div class="value" id="totalInstallments">0</div>
            </div>
        </div>
        
        <!-- Tabs for different data -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('borrowers')">üë• Borrowers</div>
            <div class="tab" onclick="switchTab('lenders')">üíº Lenders</div>
            <div class="tab" onclick="switchTab('agreements')">üìã Perjanjian</div>
            <div class="tab" onclick="switchTab('installments')">üìÖ Cicilan</div>
            <div class="tab" onclick="switchTab('policy')">‚öôÔ∏è Policy Config</div>
            <div class="tab" onclick="switchTab('agent')">ü§ñ Agent Status</div>
        </div>
        
        <!-- Tab: Borrowers -->
        <div id="tab-borrowers" class="section tab-content active">
            <h2>Daftar Borrowers (Peminjam)</h2>
            <button class="btn btn-success" onclick="loadBorrowers()" style="margin-bottom: 15px;">üîÑ Refresh Data</button>
            <table id="borrowersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nama</th>
                        <th>Nomor WA</th>
                        <th>Jumlah Pinjaman</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" class="loading">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Tab: Lenders -->
        <div id="tab-lenders" class="section tab-content">
            <h2>Daftar Lenders (Pemberi Pinjaman)</h2>
            <button class="btn btn-success" onclick="loadLenders()" style="margin-bottom: 15px;">üîÑ Refresh Data</button>
            <table id="lendersTable">
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Nomor WA</th>
                        <th>Jumlah Pinjaman Aktif</th>
                        <th>Total Nilai</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" class="loading">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Tab: Agreements -->
        <div id="tab-agreements" class="section tab-content">
            <h2>Daftar Perjanjian</h2>
            <button class="btn btn-success" onclick="loadAgreements()" style="margin-bottom: 15px;">üîÑ Refresh Data</button>
            <table id="agreementsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Borrower</th>
                        <th>Total</th>
                        <th>Cicilan/Bulan</th>
                        <th>Jumlah Cicilan</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" class="loading">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Tab: Installments -->
        <div id="tab-installments" class="section tab-content">
            <h2>Daftar Cicilan</h2>
            <button class="btn btn-success" onclick="loadInstallments()" style="margin-bottom: 15px;">üîÑ Refresh Data</button>
            <table id="installmentsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Borrower</th>
                        <th>Cicilan Ke</th>
                        <th>Jumlah</th>
                        <th>Jatuh Tempo</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" class="loading">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Tab: Policy -->
        <div id="tab-policy" class="section tab-content">
            <h2>Policy Configuration</h2>
            <button class="btn btn-success" onclick="loadPolicy()" style="margin-bottom: 15px;">üîÑ Refresh Policy</button>
            <div id="policyContent">
                <p class="loading">Memuat policy...</p>
            </div>
        </div>
        
        <!-- Tab: Agent Status -->
        <div id="tab-agent" class="section tab-content">
            <h2>ü§ñ Agent Status</h2>
            <button class="btn btn-success" onclick="loadAgentStatus()" style="margin-bottom: 15px;">üîÑ Refresh Status</button>
            <div id="agentStatusContent">
                <p class="loading">Memuat status agent...</p>
            </div>
        </div>
        
        <!-- OpenClaw Jobs -->
        <div class="section">
            <h2>üîî OpenClaw Reminder Jobs</h2>
            <button class="btn btn-primary" onclick="loadJobs()">üîÑ Check Jobs</button>
            <div id="jobsContent" style="margin-top: 15px;">
                <p class="loading">Klik Refresh untuk melihat jobs</p>
            </div>
        </div>
    </div>
    
    <script>
        // Format rupiah
        function formatRupiah(angka) {
            if (!angka) return 'Rp 0';
            return 'Rp ' + parseInt(angka).toLocaleString('id-ID');
        }
        
        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Load data for tab
            console.log('Loading tab:', tabName);
            if (tabName === 'borrowers') loadBorrowers();
            if (tabName === 'lenders') loadLenders();
            if (tabName === 'agreements') loadAgreements();
            if (tabName === 'installments') loadInstallments();
            if (tabName === 'policy') loadPolicy();
            if (tabName === 'agent') loadAgentStatus();
        }
        
        // WhatsApp Functions
        let qrTimeoutId = null;
        
        async function refreshWA() {
            try {
                document.getElementById('waStatusText').innerHTML = '<span class="loading">Mengecek...</span>';
                
                const res = await fetch('/api/public/whatsapp/status');
                const data = await res.json();
                
                if (data.connected) {
                    // Connected state
                    document.getElementById('waStatusText').innerHTML = '<span style="color: #10b981;">üü¢ Connected</span>';
                    document.getElementById('waConnected').style.display = 'block';
                    document.getElementById('waPhoneDisplay').style.display = 'block';
                    document.getElementById('waPhoneNumber').textContent = data.phoneNumber || '-';
                    document.getElementById('btnLogout').style.display = 'inline-block';
                    document.getElementById('btnGenerateQR').style.display = 'none';
                    document.getElementById('qrCodeContainer').style.display = 'none';
                    document.getElementById('waDisconnected').style.display = 'none';
                    document.getElementById('qrLoading').style.display = 'none';
                    
                    // Clear any pending QR timeout
                    if (qrTimeoutId) {
                        clearTimeout(qrTimeoutId);
                        qrTimeoutId = null;
                    }
                    
                } else {
                    // Disconnected state - show generate button
                    document.getElementById('waStatusText').innerHTML = '<span style="color: #ef4444;">üî¥ Disconnected</span>';
                    document.getElementById('waConnected').style.display = 'none';
                    document.getElementById('waPhoneDisplay').style.display = 'none';
                    document.getElementById('waPhoneNumber').textContent = '-';
                    document.getElementById('btnLogout').style.display = 'none';
                    document.getElementById('btnGenerateQR').style.display = 'inline-block';
                    document.getElementById('qrCodeContainer').style.display = 'none';
                    document.getElementById('waDisconnected').style.display = 'block';
                    document.getElementById('qrLoading').style.display = 'none';
                }
            } catch (e) {
                document.getElementById('waStatusText').innerHTML = '<span style="color: #ef4444;">üî¥ Error</span>';
                console.error('Refresh WA error:', e);
            }
        }
        
        async function generateQRCode() {
            try {
                document.getElementById('btnGenerateQR').disabled = true;
                document.getElementById('btnGenerateQR').textContent = '‚è≥ Generating...';
                document.getElementById('qrLoading').style.display = 'block';
                document.getElementById('waDisconnected').style.display = 'none';
                
                const res = await fetch('/api/public/whatsapp/status');
                const data = await res.json();
                
                document.getElementById('qrLoading').style.display = 'none';
                
                if (data.connected) {
                    // Sudah connected, refresh status saja
                    refreshWA();
                    return;
                }
                
                if (data.qrCode) {
                    // Show QR code
                    document.getElementById('qrCodeImage').src = data.qrCode;
                    document.getElementById('qrCodeContainer').style.display = 'block';
                    document.getElementById('waStatusText').innerHTML = '<span style="color: #f59e0b;">üü° Scan QR Code</span>';
                    
                    // Set timeout 2 menit
                    document.getElementById('qrTimeout').textContent = '‚è±Ô∏è QR berlaku 2 menit';
                    document.getElementById('qrTimeout').style.color = '#ef4444';
                    
                    qrTimeoutId = setTimeout(() => {
                        // QR expired
                        document.getElementById('qrCodeContainer').style.display = 'none';
                        document.getElementById('waDisconnected').style.display = 'block';
                        document.getElementById('waStatusText').innerHTML = '<span style="color: #ef4444;">üî¥ QR Expired</span>';
                        document.getElementById('btnGenerateQR').disabled = false;
                        document.getElementById('btnGenerateQR').textContent = 'üì± Generate QR Code';
                        alert('QR Code expired. Silakan generate ulang.');
                    }, 120000); // 2 menit
                    
                } else {
                    // QR belum ready, coba lagi
                    document.getElementById('waStatusText').innerHTML = '<span style="color: #f97316;">üü† QR belum ready, coba lagi...</span>';
                    document.getElementById('waDisconnected').style.display = 'block';
                    document.getElementById('btnGenerateQR').disabled = false;
                    document.getElementById('btnGenerateQR').textContent = 'üì± Generate QR Code';
                }
                
            } catch (e) {
                document.getElementById('qrLoading').style.display = 'none';
                document.getElementById('waDisconnected').style.display = 'block';
                document.getElementById('waStatusText').innerHTML = '<span style="color: #ef4444;">üî¥ Error</span>';
                document.getElementById('btnGenerateQR').disabled = false;
                document.getElementById('btnGenerateQR').textContent = 'üì± Generate QR Code';
                console.error('Generate QR error:', e);
            }
        }
        
        async function logoutWA() {
            if (!confirm('Yakin logout?')) return;
            try {
                await fetch('/api/public/whatsapp/logout', { method: 'POST' });
                alert('WhatsApp logged out');
                refreshWA();
            } catch (e) {
                alert('Gagal logout');
            }
        }
        
        // Load Stats
        async function loadStats() {
            try {
                const res = await fetch('/api/openclaw/status', {
                    headers: { 'X-API-Key': 'bukuhutang_openclaw_2026_secure' }
                });
                const data = await res.json();
                
                document.getElementById('totalPiutang').textContent = formatRupiah(data.stats.pendingDebts * 1000000);
                document.getElementById('totalAgreements').textContent = data.stats.activeAgreements;
                document.getElementById('totalInstallments').textContent = data.stats.pendingInstallments;
            } catch (e) {
                console.error('Load stats error:', e);
            }
        }
        
        // Load Borrowers
        async function loadBorrowers() {
            try {
                const tbody = document.querySelector('#borrowersTable tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Memuat...</td></tr>';
                
                const res = await fetch('/api/public/agreements');
                const data = await res.json();
                
                if (!data.agreements || data.agreements.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty">Tidak ada data</td></tr>';
                    return;
                }
                
                // Extract unique borrowers
                const borrowers = {};
                data.agreements.forEach(a => {
                    if (!borrowers[a.borrower_phone]) {
                        borrowers[a.borrower_phone] = {
                            name: a.borrower_name,
                            phone: a.borrower_phone,
                            total: 0,
                            count: 0
                        };
                    }
                    borrowers[a.borrower_phone].total += a.total_amount;
                    borrowers[a.borrower_phone].count += 1;
                });
                
                tbody.innerHTML = Object.values(borrowers).map(b => `
                    <tr>
                        <td>-</td>
                        <td>${b.name}</td>
                        <td>${b.phone}</td>
                        <td>${formatRupiah(b.total)}</td>
                        <td><span class="status active">Active</span></td>
                        <td><button class="btn btn-primary" onclick="alert('Kirim reminder ke ${b.name}')">üì± Reminder</button></td>
                    </tr>
                `).join('');
            } catch (e) {
                document.querySelector('#borrowersTable tbody').innerHTML = '<tr><td colspan="6" class="empty">Gagal memuat data</td></tr>';
            }
        }
        
        // Load Lenders
        async function loadLenders() {
            try {
                const tbody = document.querySelector('#lendersTable tbody');
                tbody.innerHTML = '<tr><td colspan="4" class="loading">Memuat...</td></tr>';
                
                const res = await fetch('/api/public/agreements');
                const data = await res.json();
                
                if (!data.agreements || data.agreements.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty">Tidak ada data</td></tr>';
                    return;
                }
                
                // Extract unique lenders (actual_lender)
                const lenders = {};
                data.agreements.forEach(a => {
                    const lenderPhone = a.actual_lender_phone || 'Unknown';
                    const lenderName = a.actual_lender_name || 'Unknown';
                    
                    if (!lenders[lenderPhone]) {
                        lenders[lenderPhone] = {
                            name: lenderName,
                            phone: lenderPhone,
                            total: 0,
                            count: 0
                        };
                    }
                    lenders[lenderPhone].total += a.total_amount || 0;
                    lenders[lenderPhone].count += 1;
                });
                
                const lendersArray = Object.values(lenders);
                if (lendersArray.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty">Tidak ada lender</td></tr>';
                    return;
                }
                
                tbody.innerHTML = lendersArray.map(l => `
                    <tr>
                        <td>${l.name}</td>
                        <td>${l.phone}</td>
                        <td>${l.count} perjanjian</td>
                        <td>${formatRupiah(l.total)}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Load lenders error:', e);
                document.querySelector('#lendersTable tbody').innerHTML = '<tr><td colspan="4" class="empty">Error: ' + e.message + '</td></tr>';
            }
        }
        
        // Load Agreements
        async function loadAgreements() {
            try {
                const tbody = document.querySelector('#agreementsTable tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Memuat...</td></tr>';
                
                // Sample data
                tbody.innerHTML = `
                    <tr>
                        <td>1</td>
                        <td>Budi Peminjam</td>
                        <td>${formatRupiah(2000000)}</td>
                        <td>${formatRupiah(500000)}</td>
                        <td>4x</td>
                        <td><span class="status active">Active</span></td>
                    </tr>
                `;
            } catch (e) {
                console.error('Load agreements error:', e);
            }
        }
        
        // Load Installments
        async function loadInstallments() {
            try {
                const tbody = document.querySelector('#installmentsTable tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Memuat...</td></tr>';
                
                const res = await fetch('/api/public/installments');
                const data = await res.json();
                
                if (!data.installments || data.installments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty">Tidak ada data</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.installments.map(inst => {
                    const statusClass = inst.status === 'paid' ? 'paid' : 
                                       new Date(inst.due_date) < new Date() ? 'overdue' : 'pending';
                    return `
                        <tr>
                            <td>${inst.id}</td>
                            <td>${inst.borrower_name}</td>
                            <td>${inst.installment_number}</td>
                            <td>${formatRupiah(inst.amount)}</td>
                            <td>${inst.due_date}</td>
                            <td><span class="status ${statusClass}">${inst.status}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                document.querySelector('#installmentsTable tbody').innerHTML = '<tr><td colspan="6" class="empty">Gagal memuat data</td></tr>';
            }
        }
        
        // Load Policy
        async function loadPolicy() {
            try {
                const res = await fetch('/api/public/policy');
                const data = await res.json();
                
                let html = '<table style="width: 100%;">';
                html += '<thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>';
                
                for (const [key, value] of Object.entries(data.policy)) {
                    html += `<tr><td>${key}</td><td>${value}</td></tr>`;
                }
                html += '</tbody></table>';
                
                document.getElementById('policyContent').innerHTML = html;
            } catch (e) {
                document.getElementById('policyContent').innerHTML = '<p class="empty">Gagal memuat policy</p>';
            }
        }
        
        // Load Agent Status
        async function loadAgentStatus() {
            try {
                const res = await fetch('/api/public/agent-status');
                const data = await res.json();
                
                const statusColor = data.status === 'active' ? '#10b981' : '#ef4444';
                const statusIcon = data.status === 'active' ? 'üü¢' : 'üî¥';
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-card" style="min-height: auto; padding: 15px;">
                            <div class="icon">${statusIcon}</div>
                            <h3>Agent Status</h3>
                            <div class="value" style="font-size: 1.2em; color: ${statusColor};">${data.status.toUpperCase()}</div>
                        </div>
                        <div class="stat-card" style="min-height: auto; padding: 15px;">
                            <div class="icon">üìä</div>
                            <h3>Total Jobs</h3>
                            <div class="value" style="font-size: 1.2em;">${data.jobs.total}</div>
                        </div>
                        <div class="stat-card" style="min-height: auto; padding: 15px;">
                            <div class="icon">üîî</div>
                            <h3>Upcoming Reminders</h3>
                            <div class="value" style="font-size: 1.2em;">${data.stats.upcomingReminders}</div>
                        </div>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px; color: #94a3b8;">üìà System Stats</h3>
                    <table style="width: 100%; margin-bottom: 20px;">
                        <tbody>
                            <tr><td>Pending Debts</td><td style="text-align: right; font-weight: 600;">${data.stats.pendingDebts}</td></tr>
                            <tr><td>Overdue Debts</td><td style="text-align: right; font-weight: 600; color: #fca5a5;">${data.stats.overdueDebts}</td></tr>
                            <tr><td>Active Agreements</td><td style="text-align: right; font-weight: 600; color: #6ee7b7;">${data.stats.activeAgreements}</td></tr>
                            <tr><td>Pending Installments</td><td style="text-align: right; font-weight: 600; color: #fcd34d;">${data.stats.pendingInstallments}</td></tr>
                        </tbody>
                    </table>
                    
                    <h3 style="margin: 20px 0 10px; color: #94a3b8;">üîß Job Queue</h3>
                    <table style="width: 100%; margin-bottom: 20px;">
                        <tbody>
                            <tr><td>Reminder Jobs</td><td style="text-align: right; font-weight: 600;">${data.jobs.reminders}</td></tr>
                            <tr><td>Installment Jobs</td><td style="text-align: right; font-weight: 600;">${data.jobs.installments}</td></tr>
                            <tr><td>Total Jobs</td><td style="text-align: right; font-weight: 600; color: #60a5fa;">${data.jobs.total}</td></tr>
                        </tbody>
                    </table>
                    
                    <div style="background: #1e293b; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <p style="margin: 0; color: #94a3b8; font-size: 0.9em;">
                            <strong>‚è∞ Last Check:</strong> ${new Date(data.timestamp).toLocaleString('id-ID')}<br>
                            <strong>üîÑ Next Check:</strong> ${new Date(data.nextCheck).toLocaleString('id-ID')}
                        </p>
                    </div>
                `;
                
                document.getElementById('agentStatusContent').innerHTML = html;
            } catch (e) {
                document.getElementById('agentStatusContent').innerHTML = '<p class="empty">Gagal memuat status agent</p>';
            }
        }
        
        // Load Jobs
        async function loadJobs() {
            try {
                const res = await fetch('/api/openclaw/jobs?type=all', {
                    headers: { 'X-API-Key': 'bukuhutang_openclaw_2026_secure' }
                });
                const data = await res.json();
                
                if (data.count === 0) {
                    document.getElementById('jobsContent').innerHTML = '<p class="empty">Tidak ada pending jobs</p>';
                } else {
                    let html = `<p><strong>${data.count} jobs ditemukan:</strong></p><ul>`;
                    data.jobs.forEach(job => {
                        html += `<li>${job.type}: ${job.debtorName} - ${formatRupiah(job.amount)} (Due: ${job.dueDate})</li>`;
                    });
                    html += '</ul>';
                    document.getElementById('jobsContent').innerHTML = html;
                }
            } catch (e) {
                document.getElementById('jobsContent').innerHTML = '<p class="empty">Gagal memuat jobs</p>';
            }
        }
        
        // Init
        window.onload = function() {
            refreshWA();  // Cek status sekali saja
            loadStats();
            loadBorrowers();
        };
    </script>
</body>
</html>
